<!DOCTYPE html>
<html>

<head>
    <title>Rainbow math trial</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="./coloring.css">
    <script type="module" src="coloring.mjs"></script>
    <script type="module">
        import {EditHistory, updateTestArea} from "./coloring.mjs"

        // keep track of history
        let testAreaHistory = {};
        window.update = function update(ev) {
            updateTestArea.bind(testAreaHistory[ev.target.id])(ev);
        }

        let idCounter = 100;
        function getUniqueID() {
            return 'test' + idCounter++;
        }

        window.addLine = function addLine(copyLine) {
            const template = document.getElementById('input-line-template');
            const newLine = template.content.cloneNode(true);
            template.parentNode.insertBefore(newLine, template);

            // set the line number
            const textLines = document.getElementsByClassName('test-input');
            const newLineContents = copyLine ? textLines[textLines.length-2].textContent : '';
            textLines[textLines.length-1].textContent = newLineContents;
            document.getElementsByClassName('lineNumber')[textLines.length-1].textContent = `${textLines.length}: `;

            // set up history (via an id)
            const testAreaElements = document.getElementsByClassName('test-input');
            const newTestAreaElement = testAreaElements[testAreaElements.length-1];
            newTestAreaElement.id = getUniqueID();
            testAreaHistory[newTestAreaElement.id] = new EditHistory(newLineContents);

            if (copyLine) {     // not just efficient, needed for first line because ColoringRules.Rules not yet set
                update({inputType: 'fakeEvent', target: newTestAreaElement});   // fake event for update
            }

            window.scrollTo(0,document.body.scrollHeight);
        };
    </script>
    <style>
        #add-line {
            font-size: 120%;
            margin: 1em;
        }
    </style>
</head>

<body>
    <h1>Rainbow Math</h1>
    <h2>Save and Load Stored (named) Rules</h2>
    <div id="current-rule"></div>
    <div class="rule-area">
        <label for="saveRules" style="grid-area: 1/1/3/2;">Rules:</label>
        <input type="text" placeholder="enter coloring rule name" id="rule-list-input" list="rulesList"
            style="grid-area: 1/2/3/3;">
        <datalist id="rulesList">
            <option value="foo"></option>
        </datalist> <!-- populated by code -->
        <button class='button' id="saveRules" style="grid-area: 1/3/2/4;">Save</button>
        <button class='button' id="loadRules" style="grid-area: 2/3/3/4;">Load</button>
        <span style="width: 3em; grid-area: 1/4/2/5;" aria-hidden="true"></span> <!-- spacing-->
        <button class='button' id="copyToClipboard" style="grid-area: 1/5/2/6;">Copy to Clipboard</button>
        <button class='button' id="pasteFromClipboard" style="grid-area: 2/5/3/6;">Paste from Clipboard</button>

        <button class='button' id='removeAllRules' style="grid-column: 1/7;">Remove all stored rules</button>
    </div>

    <h2>Test Area</h2>

    <p>In the box below, try typing some text (only linear math is allowed):
    </p>
    <template id="input-line-template">
        <p>
            Line <span class="lineNumber"></span>
            <colored-edit-area class='test-input' contenteditable="true" spellcheck="false" oninput="update(event)"> </colored-edit-area>
        </p>
    </template>
    <button id="add-line" class="button" onclick="addLine(false)">Add another line</button>
    <button id="add-line" class="button" onclick="addLine(true)">Copy line</button>
    <div class="palettes">
        <span>Use the keyboard or these buttons:</span>
        <span id='symbols-test' class='grid'>+-·×÷=&lt;&gt;±≠≤≥()[]⌊⌋⌈⌉|</span> <!-- filled in by script -->
    </div>

    <script type="module">
        addLine(false);  // start with one line
    </script>
</body>

</html>